"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.downloadWAD = downloadWAD;
exports.setupWAD = setupWAD;
exports.default = exports.isAdmin = exports.getWADExecutablePath = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

var _es6Error = _interopRequireDefault(require("es6-error"));

var _registry = require("./registry");

const WAD_VER = '1.2.99';
const WAD_DOWNLOAD_MD5 = Object.freeze({
  x32: '23745e6ed373bc969ff7c4493e32756a',
  x64: '2923fc539f389d47754a7521ee50108e',
  arm64: 'b9af4222a3fb0d688ecfbf605d1c4500'
});
const ARCH_MAPPING = Object.freeze({
  x32: 'x86',
  x64: 'x64',
  arm64: 'arm64'
});
const WAD_DOWNLOAD_TIMEOUT_MS = 60000;
const POSSIBLE_WAD_INSTALL_ROOTS = [process.env['ProgramFiles(x86)'], process.env.ProgramFiles, `${process.env.SystemDrive || 'C:'}\\\\Program Files`];
const WAD_EXE_NAME = 'WinAppDriver.exe';
const UNINSTALL_REG_ROOT = 'HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall';
const REG_ENTRY_VALUE = 'Windows Application Driver';
const REG_ENTRY_KEY = 'DisplayName';
const REG_ENTRY_TYPE = 'REG_SZ';

const INST_LOCATION_SCRIPT_BY_GUID = guid => `
Set installer = CreateObject("WindowsInstaller.Installer")
Set session = installer.OpenProduct("${guid}")
session.DoAction("CostInitialize")
session.DoAction("CostFinalize")
WScript.Echo session.Property("INSTALLFOLDER")
`.replace(/\n/g, '\r\n');

function generateWadDownloadLink() {
  const wadArch = ARCH_MAPPING[process.arch];

  if (!wadArch) {
    throw new Error(`System architecture '${process.arch}' is not supported by Windows Application Driver. ` + `The only supported architectures are: ${_lodash.default.keys(ARCH_MAPPING)}`);
  }

  return `https://github.com/Microsoft/WinAppDriver` + `/releases/download/v${WAD_VER}/WindowsApplicationDriver-${WAD_VER}-win-${wadArch}.exe`;
}

async function fetchMsiInstallLocation(installerGuid) {
  const tmpRoot = await _appiumSupport.tempDir.openDir();

  const scriptPath = _path.default.join(tmpRoot, 'get_wad_inst_location.vbs');

  try {
    await _appiumSupport.fs.writeFile(scriptPath, INST_LOCATION_SCRIPT_BY_GUID(installerGuid), 'latin1');
    const {
      stdout
    } = await (0, _teen_process.exec)('cscript.exe', ['/Nologo', scriptPath]);
    return _lodash.default.trim(stdout);
  } finally {
    await _appiumSupport.fs.rimraf(tmpRoot);
  }
}

class WADNotFoundError extends _es6Error.default {}

const getWADExecutablePath = _lodash.default.memoize(async function getWADInstallPath() {
  const wadPath = process.env.APPIUM_WAD_PATH;

  if (await _appiumSupport.fs.exists(wadPath)) {
    _logger.default.debug(`Loaded WinAppDriver path from the APPIUM_WAD_PATH environment variable: ${wadPath}`);

    return wadPath;
  }

  const pathCandidates = POSSIBLE_WAD_INSTALL_ROOTS.filter(Boolean).map(root => _path.default.resolve(root, REG_ENTRY_VALUE, WAD_EXE_NAME));

  for (const result of pathCandidates) {
    if (await _appiumSupport.fs.exists(result)) {
      return result;
    }
  }

  _logger.default.debug('Did not detect WAD executable at any of the default install locations');

  _logger.default.debug('Checking the system registry for the corresponding MSI entry');

  try {
    const uninstallEntries = await (0, _registry.queryRegistry)(UNINSTALL_REG_ROOT);
    const wadEntry = uninstallEntries.find(({
      key,
      type,
      value
    }) => key === REG_ENTRY_KEY && value === REG_ENTRY_VALUE && type === REG_ENTRY_TYPE);

    if (wadEntry) {
      _logger.default.debug(`Found MSI entry: ${JSON.stringify(wadEntry)}`);

      const installerGuid = _lodash.default.last(wadEntry.root.split('\\'));

      const result = _path.default.join(await fetchMsiInstallLocation(installerGuid), WAD_EXE_NAME);

      _logger.default.debug(`Checking if WAD exists at '${result}'`);

      if (await _appiumSupport.fs.exists(result)) {
        return result;
      }

      _logger.default.debug(result);
    } else {
      _logger.default.debug('No WAD MSI entries have been found');
    }
  } catch (e) {
    if (e.stderr) {
      _logger.default.debug(e.stderr);
    }

    _logger.default.debug(e.stack);
  }

  throw new WADNotFoundError(`${WAD_EXE_NAME} has not been found in any of these ` + `locations: ${pathCandidates}. Is it installed?`);
});

exports.getWADExecutablePath = getWADExecutablePath;

async function downloadWAD() {
  const downloadLink = generateWadDownloadLink();

  const installerPath = _path.default.resolve(await _appiumSupport.tempDir.staticDir(), `wad_installer_${WAD_VER}_${_appiumSupport.util.uuidV4()}.exe`);

  _logger.default.info(`Downloading ${downloadLink} to '${installerPath}'`);

  await _appiumSupport.net.downloadFile(downloadLink, installerPath, {
    timeout: WAD_DOWNLOAD_TIMEOUT_MS
  });
  const downloadedMd5 = await _appiumSupport.fs.md5(installerPath);
  const expectedMd5 = WAD_DOWNLOAD_MD5[process.arch];

  if (downloadedMd5 !== expectedMd5) {
    await _appiumSupport.fs.rimraf(installerPath);
    throw new Error(`Installer executable checksum validation error: expected ${expectedMd5} but got ${downloadedMd5}`);
  }

  return installerPath;
}

const isAdmin = _lodash.default.memoize(async function isAdmin() {
  try {
    await (0, _teen_process.exec)('fsutil.exe', ['dirty', 'query', process.env.SystemDrive || 'C:']);
    return true;
  } catch (ign) {
    return false;
  }
});

exports.isAdmin = isAdmin;

async function setupWAD() {
  if (!_appiumSupport.system.isWindows()) {
    throw new Error(`Can only download WinAppDriver on Windows!`);
  }

  try {
    return await getWADExecutablePath();
  } catch (e) {
    if (!(e instanceof WADNotFoundError)) {
      throw e;
    }

    _logger.default.info(`WinAppDriver doesn't exist, setting up`);
  }

  if (!(await isAdmin())) {
    throw new Error(`You are not running as an administrator so WinAppDriver cannot be installed for you; please reinstall as admin`);
  }

  const installerPath = await downloadWAD();

  _logger.default.info('Running installer');

  try {
    await (0, _teen_process.exec)(installerPath, ['/install', '/quiet', '/norestart']);
  } finally {
    await _appiumSupport.fs.rimraf(installerPath);
  }
}

var _default = setupWAD;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsZXIuanMiXSwibmFtZXMiOlsiV0FEX1ZFUiIsIldBRF9ET1dOTE9BRF9NRDUiLCJPYmplY3QiLCJmcmVlemUiLCJ4MzIiLCJ4NjQiLCJhcm02NCIsIkFSQ0hfTUFQUElORyIsIldBRF9ET1dOTE9BRF9USU1FT1VUX01TIiwiUE9TU0lCTEVfV0FEX0lOU1RBTExfUk9PVFMiLCJwcm9jZXNzIiwiZW52IiwiUHJvZ3JhbUZpbGVzIiwiU3lzdGVtRHJpdmUiLCJXQURfRVhFX05BTUUiLCJVTklOU1RBTExfUkVHX1JPT1QiLCJSRUdfRU5UUllfVkFMVUUiLCJSRUdfRU5UUllfS0VZIiwiUkVHX0VOVFJZX1RZUEUiLCJJTlNUX0xPQ0FUSU9OX1NDUklQVF9CWV9HVUlEIiwiZ3VpZCIsInJlcGxhY2UiLCJnZW5lcmF0ZVdhZERvd25sb2FkTGluayIsIndhZEFyY2giLCJhcmNoIiwiRXJyb3IiLCJfIiwia2V5cyIsImZldGNoTXNpSW5zdGFsbExvY2F0aW9uIiwiaW5zdGFsbGVyR3VpZCIsInRtcFJvb3QiLCJ0ZW1wRGlyIiwib3BlbkRpciIsInNjcmlwdFBhdGgiLCJwYXRoIiwiam9pbiIsImZzIiwid3JpdGVGaWxlIiwic3Rkb3V0IiwidHJpbSIsInJpbXJhZiIsIldBRE5vdEZvdW5kRXJyb3IiLCJFUzZFcnJvciIsImdldFdBREV4ZWN1dGFibGVQYXRoIiwibWVtb2l6ZSIsImdldFdBREluc3RhbGxQYXRoIiwid2FkUGF0aCIsIkFQUElVTV9XQURfUEFUSCIsImV4aXN0cyIsImxvZyIsImRlYnVnIiwicGF0aENhbmRpZGF0ZXMiLCJmaWx0ZXIiLCJCb29sZWFuIiwibWFwIiwicm9vdCIsInJlc29sdmUiLCJyZXN1bHQiLCJ1bmluc3RhbGxFbnRyaWVzIiwid2FkRW50cnkiLCJmaW5kIiwia2V5IiwidHlwZSIsInZhbHVlIiwiSlNPTiIsInN0cmluZ2lmeSIsImxhc3QiLCJzcGxpdCIsImUiLCJzdGRlcnIiLCJzdGFjayIsImRvd25sb2FkV0FEIiwiZG93bmxvYWRMaW5rIiwiaW5zdGFsbGVyUGF0aCIsInN0YXRpY0RpciIsInV0aWwiLCJ1dWlkVjQiLCJpbmZvIiwibmV0IiwiZG93bmxvYWRGaWxlIiwidGltZW91dCIsImRvd25sb2FkZWRNZDUiLCJtZDUiLCJleHBlY3RlZE1kNSIsImlzQWRtaW4iLCJpZ24iLCJzZXR1cFdBRCIsInN5c3RlbSIsImlzV2luZG93cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLE9BQU8sR0FBRyxRQUFoQjtBQUNBLE1BQU1DLGdCQUFnQixHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUNyQ0MsRUFBQUEsR0FBRyxFQUFFLGtDQURnQztBQUVyQ0MsRUFBQUEsR0FBRyxFQUFFLGtDQUZnQztBQUdyQ0MsRUFBQUEsS0FBSyxFQUFFO0FBSDhCLENBQWQsQ0FBekI7QUFLQSxNQUFNQyxZQUFZLEdBQUdMLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQUNDLEVBQUFBLEdBQUcsRUFBRSxLQUFOO0FBQWFDLEVBQUFBLEdBQUcsRUFBRSxLQUFsQjtBQUF5QkMsRUFBQUEsS0FBSyxFQUFFO0FBQWhDLENBQWQsQ0FBckI7QUFDQSxNQUFNRSx1QkFBdUIsR0FBRyxLQUFoQztBQUNBLE1BQU1DLDBCQUEwQixHQUFHLENBQ2pDQyxPQUFPLENBQUNDLEdBQVIsQ0FBWSxtQkFBWixDQURpQyxFQUVqQ0QsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFlBRnFCLEVBR2hDLEdBQUVGLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRSxXQUFaLElBQTJCLElBQUssbUJBSEYsQ0FBbkM7QUFLQSxNQUFNQyxZQUFZLEdBQUcsa0JBQXJCO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsK0RBQTNCO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLDRCQUF4QjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxhQUF0QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxRQUF2Qjs7QUFDQSxNQUFN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LEVBQUMsTUFBTU8sT0FBTyxFQUFkLENBQUosRUFBc0I7QUFDcEIsVUFBTSxJQUFJM0QsS0FBSixDQUFXLGdIQUFYLENBQU47QUFDRDs7QUFFRCxRQUFNZ0QsYUFBYSxHQUFHLE1BQU1GLFdBQVcsRUFBdkM7O0FBQ0F0QixrQkFBSTRCLElBQUosQ0FBUyxtQkFBVDs7QUFDQSxNQUFJO0FBQ0YsVUFBTSx3QkFBS0osYUFBTCxFQUFvQixDQUFDLFVBQUQsRUFBYSxRQUFiLEVBQXVCLFlBQXZCLENBQXBCLENBQU47QUFDRCxHQUZELFNBRVU7QUFDUixVQUFNckMsa0JBQUdJLE1BQUgsQ0FBVWlDLGFBQVYsQ0FBTjtBQUNEO0FBQ0Y7O2VBR2NhLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgc3lzdGVtLCBmcywgdXRpbCwgbmV0LCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IEVTNkVycm9yIGZyb20gJ2VzNi1lcnJvcic7XG5pbXBvcnQgeyBxdWVyeVJlZ2lzdHJ5IH0gZnJvbSAnLi9yZWdpc3RyeSc7XG5cbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9taWNyb3NvZnQvV2luQXBwRHJpdmVyL3JlbGVhc2VzXG5jb25zdCBXQURfVkVSID0gJzEuMi45OSc7XG5jb25zdCBXQURfRE9XTkxPQURfTUQ1ID0gT2JqZWN0LmZyZWV6ZSh7XG4gIHgzMjogJzIzNzQ1ZTZlZDM3M2JjOTY5ZmY3YzQ0OTNlMzI3NTZhJyxcbiAgeDY0OiAnMjkyM2ZjNTM5ZjM4OWQ0Nzc1NGE3NTIxZWU1MDEwOGUnLFxuICBhcm02NDogJ2I5YWY0MjIyYTNmYjBkNjg4ZWNmYmY2MDVkMWM0NTAwJyxcbn0pO1xuY29uc3QgQVJDSF9NQVBQSU5HID0gT2JqZWN0LmZyZWV6ZSh7eDMyOiAneDg2JywgeDY0OiAneDY0JywgYXJtNjQ6ICdhcm02NCd9KTtcbmNvbnN0IFdBRF9ET1dOTE9BRF9USU1FT1VUX01TID0gNjAwMDA7XG5jb25zdCBQT1NTSUJMRV9XQURfSU5TVEFMTF9ST09UUyA9IFtcbiAgcHJvY2Vzcy5lbnZbJ1Byb2dyYW1GaWxlcyh4ODYpJ10sXG4gIHByb2Nlc3MuZW52LlByb2dyYW1GaWxlcyxcbiAgYCR7cHJvY2Vzcy5lbnYuU3lzdGVtRHJpdmUgfHwgJ0M6J31cXFxcXFxcXFByb2dyYW0gRmlsZXNgLFxuXTtcbmNvbnN0IFdBRF9FWEVfTkFNRSA9ICdXaW5BcHBEcml2ZXIuZXhlJztcbmNvbnN0IFVOSU5TVEFMTF9SRUdfUk9PVCA9ICdIS0xNXFxcXFNvZnR3YXJlXFxcXE1pY3Jvc29mdFxcXFxXaW5kb3dzXFxcXEN1cnJlbnRWZXJzaW9uXFxcXFVuaW5zdGFsbCc7XG5jb25zdCBSRUdfRU5UUllfVkFMVUUgPSAnV2luZG93cyBBcHBsaWNhdGlvbiBEcml2ZXInO1xuY29uc3QgUkVHX0VOVFJZX0tFWSA9ICdEaXNwbGF5TmFtZSc7XG5jb25zdCBSRUdfRU5UUllfVFlQRSA9ICdSRUdfU1onO1xuY29uc3QgSU5TVF9MT0NBVElPTl9TQ1JJUFRfQllfR1VJRCA9IChndWlkKSA9PiBgXG5TZXQgaW5zdGFsbGVyID0gQ3JlYXRlT2JqZWN0KFwiV2luZG93c0luc3RhbGxlci5JbnN0YWxsZXJcIilcblNldCBzZXNzaW9uID0gaW5zdGFsbGVyLk9wZW5Qcm9kdWN0KFwiJHtndWlkfVwiKVxuc2Vzc2lvbi5Eb0FjdGlvbihcIkNvc3RJbml0aWFsaXplXCIpXG5zZXNzaW9uLkRvQWN0aW9uKFwiQ29zdEZpbmFsaXplXCIpXG5XU2NyaXB0LkVjaG8gc2Vzc2lvbi5Qcm9wZXJ0eShcIklOU1RBTExGT0xERVJcIilcbmAucmVwbGFjZSgvXFxuL2csICdcXHJcXG4nKTtcblxuXG5mdW5jdGlvbiBnZW5lcmF0ZVdhZERvd25sb2FkTGluayAoKSB7XG4gIGNvbnN0IHdhZEFyY2ggPSBBUkNIX01BUFBJTkdbcHJvY2Vzcy5hcmNoXTtcbiAgaWYgKCF3YWRBcmNoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTeXN0ZW0gYXJjaGl0ZWN0dXJlICcke3Byb2Nlc3MuYXJjaH0nIGlzIG5vdCBzdXBwb3J0ZWQgYnkgV2luZG93cyBBcHBsaWNhdGlvbiBEcml2ZXIuIGAgK1xuICAgICAgYFRoZSBvbmx5IHN1cHBvcnRlZCBhcmNoaXRlY3R1cmVzIGFyZTogJHtfLmtleXMoQVJDSF9NQVBQSU5HKX1gKTtcbiAgfVxuICByZXR1cm4gYGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvV2luQXBwRHJpdmVyYCArXG4gICAgYC9yZWxlYXNlcy9kb3dubG9hZC92JHtXQURfVkVSfS9XaW5kb3dzQXBwbGljYXRpb25Ecml2ZXItJHtXQURfVkVSfS13aW4tJHt3YWRBcmNofS5leGVgO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaE1zaUluc3RhbGxMb2NhdGlvbiAoaW5zdGFsbGVyR3VpZCkge1xuICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIGNvbnN0IHNjcmlwdFBhdGggPSBwYXRoLmpvaW4odG1wUm9vdCwgJ2dldF93YWRfaW5zdF9sb2NhdGlvbi52YnMnKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoc2NyaXB0UGF0aCwgSU5TVF9MT0NBVElPTl9TQ1JJUFRfQllfR1VJRChpbnN0YWxsZXJHdWlkKSwgJ2xhdGluMScpO1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnY3NjcmlwdC5leGUnLCBbJy9Ob2xvZ28nLCBzY3JpcHRQYXRoXSk7XG4gICAgcmV0dXJuIF8udHJpbShzdGRvdXQpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgfVxufVxuXG5jbGFzcyBXQUROb3RGb3VuZEVycm9yIGV4dGVuZHMgRVM2RXJyb3Ige31cblxuY29uc3QgZ2V0V0FERXhlY3V0YWJsZVBhdGggPSBfLm1lbW9pemUoYXN5bmMgZnVuY3Rpb24gZ2V0V0FESW5zdGFsbFBhdGggKCkge1xuICBjb25zdCB3YWRQYXRoID0gcHJvY2Vzcy5lbnYuQVBQSVVNX1dBRF9QQVRIO1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKHdhZFBhdGgpKSB7XG4gICAgbG9nLmRlYnVnKGBMb2FkZWQgV2luQXBwRHJpdmVyIHBhdGggZnJvbSB0aGUgQVBQSVVNX1dBRF9QQVRIIGVudmlyb25tZW50IHZhcmlhYmxlOiAke3dhZFBhdGh9YCk7XG4gICAgcmV0dXJuIHdhZFBhdGg7XG4gIH1cblxuICAvLyBUT0RPOiBXQUQgaW5zdGFsbGVyIHNob3VsZCB3cml0ZSB0aGUgZnVsbCBwYXRoIHRvIGl0IGludG8gdGhlIHN5c3RlbSByZWdpc3RyeVxuICBjb25zdCBwYXRoQ2FuZGlkYXRlcyA9IFBPU1NJQkxFX1dBRF9JTlNUQUxMX1JPT1RTXG4gICAgLy8gcmVtb3ZlIHVuc2V0IGVudiB2YXJpYWJsZXNcbiAgICAuZmlsdGVyKEJvb2xlYW4pXG4gICAgLy8gY29uc3RydWN0IGZ1bGwgcGF0aFxuICAgIC5tYXAoKHJvb3QpID0+IHBhdGgucmVzb2x2ZShyb290LCBSRUdfRU5UUllfVkFMVUUsIFdBRF9FWEVfTkFNRSkpO1xuICBmb3IgKGNvbnN0IHJlc3VsdCBvZiBwYXRoQ2FuZGlkYXRlcykge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHMocmVzdWx0KSkge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gIH1cbiAgbG9nLmRlYnVnKCdEaWQgbm90IGRldGVjdCBXQUQgZXhlY3V0YWJsZSBhdCBhbnkgb2YgdGhlIGRlZmF1bHQgaW5zdGFsbCBsb2NhdGlvbnMnKTtcbiAgbG9nLmRlYnVnKCdDaGVja2luZyB0aGUgc3lzdGVtIHJlZ2lzdHJ5IGZvciB0aGUgY29ycmVzcG9uZGluZyBNU0kgZW50cnknKTtcbiAgdHJ5IHtcbiAgICBjb25zdCB1bmluc3RhbGxFbnRyaWVzID0gYXdhaXQgcXVlcnlSZWdpc3RyeShVTklOU1RBTExfUkVHX1JPT1QpO1xuICAgIGNvbnN0IHdhZEVudHJ5ID0gdW5pbnN0YWxsRW50cmllcy5maW5kKCh7a2V5LCB0eXBlLCB2YWx1ZX0pID0+XG4gICAgICBrZXkgPT09IFJFR19FTlRSWV9LRVkgJiYgdmFsdWUgPT09IFJFR19FTlRSWV9WQUxVRSAmJiB0eXBlID09PSBSRUdfRU5UUllfVFlQRVxuICAgICk7XG4gICAgaWYgKHdhZEVudHJ5KSB7XG4gICAgICBsb2cuZGVidWcoYEZvdW5kIE1TSSBlbnRyeTogJHtKU09OLnN0cmluZ2lmeSh3YWRFbnRyeSl9YCk7XG4gICAgICBjb25zdCBpbnN0YWxsZXJHdWlkID0gXy5sYXN0KHdhZEVudHJ5LnJvb3Quc3BsaXQoJ1xcXFwnKSk7XG4gICAgICAvLyBXQUQgTVNJIGluc3RhbGxlciBsZWF2ZXMgSW5zdGFsbExvY2F0aW9uIHJlZ2lzdHJ5IHZhbHVlIGVtcHR5LFxuICAgICAgLy8gc28gd2UgbmVlZCB0byBiZSBoYWNreSBoZXJlXG4gICAgICBjb25zdCByZXN1bHQgPSBwYXRoLmpvaW4oYXdhaXQgZmV0Y2hNc2lJbnN0YWxsTG9jYXRpb24oaW5zdGFsbGVyR3VpZCksIFdBRF9FWEVfTkFNRSk7XG4gICAgICBsb2cuZGVidWcoYENoZWNraW5nIGlmIFdBRCBleGlzdHMgYXQgJyR7cmVzdWx0fSdgKTtcbiAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMocmVzdWx0KSkge1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKHJlc3VsdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm8gV0FEIE1TSSBlbnRyaWVzIGhhdmUgYmVlbiBmb3VuZCcpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLnN0ZGVycikge1xuICAgICAgbG9nLmRlYnVnKGUuc3RkZXJyKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGUuc3RhY2spO1xuICB9XG4gIHRocm93IG5ldyBXQUROb3RGb3VuZEVycm9yKGAke1dBRF9FWEVfTkFNRX0gaGFzIG5vdCBiZWVuIGZvdW5kIGluIGFueSBvZiB0aGVzZSBgICtcbiAgICBgbG9jYXRpb25zOiAke3BhdGhDYW5kaWRhdGVzfS4gSXMgaXQgaW5zdGFsbGVkP2ApO1xufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkV0FEICgpIHtcbiAgY29uc3QgZG93bmxvYWRMaW5rID0gZ2VuZXJhdGVXYWREb3dubG9hZExpbmsoKTtcbiAgY29uc3QgaW5zdGFsbGVyUGF0aCA9IHBhdGgucmVzb2x2ZShhd2FpdCB0ZW1wRGlyLnN0YXRpY0RpcigpLFxuICAgIGB3YWRfaW5zdGFsbGVyXyR7V0FEX1ZFUn1fJHt1dGlsLnV1aWRWNCgpfS5leGVgKTtcbiAgbG9nLmluZm8oYERvd25sb2FkaW5nICR7ZG93bmxvYWRMaW5rfSB0byAnJHtpbnN0YWxsZXJQYXRofSdgKTtcbiAgYXdhaXQgbmV0LmRvd25sb2FkRmlsZShkb3dubG9hZExpbmssIGluc3RhbGxlclBhdGgsIHt0aW1lb3V0OiBXQURfRE9XTkxPQURfVElNRU9VVF9NU30pO1xuICBjb25zdCBkb3dubG9hZGVkTWQ1ID0gYXdhaXQgZnMubWQ1KGluc3RhbGxlclBhdGgpO1xuICBjb25zdCBleHBlY3RlZE1kNSA9IFdBRF9ET1dOTE9BRF9NRDVbcHJvY2Vzcy5hcmNoXTtcbiAgaWYgKGRvd25sb2FkZWRNZDUgIT09IGV4cGVjdGVkTWQ1KSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGluc3RhbGxlclBhdGgpO1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBJbnN0YWxsZXIgZXhlY3V0YWJsZSBjaGVja3N1bSB2YWxpZGF0aW9uIGVycm9yOiBleHBlY3RlZCAke2V4cGVjdGVkTWQ1fSBidXQgZ290ICR7ZG93bmxvYWRlZE1kNX1gXG4gICAgKTtcbiAgfVxuICByZXR1cm4gaW5zdGFsbGVyUGF0aDtcbn1cblxuY29uc3QgaXNBZG1pbiA9IF8ubWVtb2l6ZShhc3luYyBmdW5jdGlvbiBpc0FkbWluICgpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKCdmc3V0aWwuZXhlJywgWydkaXJ0eScsICdxdWVyeScsIHByb2Nlc3MuZW52LlN5c3RlbURyaXZlIHx8ICdDOiddKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCAoaWduKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59KTtcblxuYXN5bmMgZnVuY3Rpb24gc2V0dXBXQUQgKCkge1xuICBpZiAoIXN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2FuIG9ubHkgZG93bmxvYWQgV2luQXBwRHJpdmVyIG9uIFdpbmRvd3MhYCk7XG4gIH1cblxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCBnZXRXQURFeGVjdXRhYmxlUGF0aCgpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCEoZSBpbnN0YW5jZW9mIFdBRE5vdEZvdW5kRXJyb3IpKSB7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgV2luQXBwRHJpdmVyIGRvZXNuJ3QgZXhpc3QsIHNldHRpbmcgdXBgKTtcbiAgfVxuXG4gIGlmICghYXdhaXQgaXNBZG1pbigpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBZb3UgYXJlIG5vdCBydW5uaW5nIGFzIGFuIGFkbWluaXN0cmF0b3Igc28gV2luQXBwRHJpdmVyIGNhbm5vdCBiZSBpbnN0YWxsZWQgZm9yIHlvdTsgcGxlYXNlIHJlaW5zdGFsbCBhcyBhZG1pbmApO1xuICB9XG5cbiAgY29uc3QgaW5zdGFsbGVyUGF0aCA9IGF3YWl0IGRvd25sb2FkV0FEKCk7XG4gIGxvZy5pbmZvKCdSdW5uaW5nIGluc3RhbGxlcicpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoaW5zdGFsbGVyUGF0aCwgWycvaW5zdGFsbCcsICcvcXVpZXQnLCAnL25vcmVzdGFydCddKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYoaW5zdGFsbGVyUGF0aCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgZG93bmxvYWRXQUQsIHNldHVwV0FELCBnZXRXQURFeGVjdXRhYmxlUGF0aCwgaXNBZG1pbiB9O1xuZXhwb3J0IGRlZmF1bHQgc2V0dXBXQUQ7XG4iXSwiZmlsZSI6ImxpYi9pbnN0YWxsZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
